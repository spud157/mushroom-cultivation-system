<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M.U.S.H - Phase Management</title>
    <link rel="stylesheet" href="terminal-status.css">
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <header class="dashboard-header-section">
            <div class="header-content">
                <div class="dashboard-header">
                    <h1 class="main-title">M.U.S.H</h1>
                    <div class="header-controls-centered">
                        <button class="btn btn-primary" onclick="window.location.href='index.html'">
                            Dashboard
                        </button>
                        <button class="btn btn-success" onclick="window.location.href='automation-rules.html'">
                            Automation Rules
                        </button>
                        <button class="btn btn-info" onclick="window.location.href='alerts.html'">
                            Alerts & Notifications
                        </button>
                        <button class="btn btn-warning active" onclick="window.location.href='phase-management.html'">
                            Phase Management
                        </button>
                        <button class="btn btn-secondary" onclick="window.location.href='batch-operations.html'">
                            Batch Operations
                        </button>
                        <button class="btn btn-danger" onclick="window.location.href='sensor-data.html'">
                            Sensor Data
                        </button>
                        <button class="btn btn-dark" onclick="window.location.href='user-management.html'">
                            User Management
                        </button>
                        <button class="btn btn-light" onclick="logout()">
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- System Status -->
            <section class="system-status">
                <div class="status-card">
                    <h3>Phase Management</h3>
                    <div class="status-indicators">
                        <div class="status-item">
                            <span class="status-label">Active Phases:</span>
                            <span class="status-value" id="active-phases-count">0</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Scheduled Changes:</span>
                            <span class="status-value" id="scheduled-changes-count">0</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Total Harvests:</span>
                            <span class="status-value" id="total-harvests-count">0</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Phase Management Section -->
            <section class="phase-section">
                <div class="section-header">
                    <h2>Growth Phase Control</h2>
                    <div class="header-controls">
                        <button class="btn btn-primary" onclick="schedulePhaseChange()">Schedule Change</button>
                        <button class="btn btn-success" onclick="recordHarvest()">Record Harvest</button>
                        <button class="btn btn-warning" onclick="refreshPhaseData()">Refresh</button>
                    </div>
                </div>
                
                <!-- Tab Navigation -->
                <div class="phase-tabs">
                    <button class="tab-btn active" onclick="showPhaseTab('overview')">Phase Overview</button>
                    <button class="tab-btn" onclick="showPhaseTab('schedule')">Phase Scheduling</button>
                    <button class="tab-btn" onclick="showPhaseTab('harvest')">Harvest Tracking</button>
                </div>

                <!-- Content Area -->
                <div id="phase-content" class="tab-content">
                    <div class="loading-message">Loading phase data...</div>
                </div>
            </section>
        </main>
    </div>

    <!-- Trademark Footer -->
    <div class="trademark-footer">
        <span class="trademark-text">© Kroll Management LLC</span>
    </div>

    <script src="simple_app.js"></script>
    <script>
        // Page-specific initialization
        window.addEventListener('load', async function() {
            if (!checkAuthentication()) return;
            
            await loadPhaseData();
            showPhaseTab('overview');
        });

        // Phase management functions
        async function loadPhaseData() {
            try {
                const [phasesResponse, harvestResponse, environmentsResponse] = await Promise.all([
                    fetch(`${API_BASE_URL}/phases`),
                    fetch(`${API_BASE_URL}/harvest`),
                    fetch(`${API_BASE_URL}/environments`)
                ]);
                
                const phases = await phasesResponse.json();
                const harvest = await harvestResponse.json();
                const environments = await environmentsResponse.json();
                
                window.phaseData = { phases, harvest, environments };
            } catch (error) {
                console.error('Error loading phase data:', error);
                document.getElementById('phase-content').innerHTML = '<div class="error-message">Failed to load phase data</div>';
            }
        }

        function showPhaseTab(tab) {
            const content = document.getElementById('phase-content');
            const data = window.phaseData || {};
            
            // Update tab buttons
            document.querySelectorAll('.phase-tabs .tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            switch(tab) {
                case 'overview':
                    content.innerHTML = renderPhaseOverview(data.phases || []);
                    break;
                case 'schedule':
                    content.innerHTML = renderPhaseScheduling(data.environments || []);
                    break;
                case 'harvest':
                    content.innerHTML = renderHarvestTracking(data.harvest || []);
                    break;
            }
        }

        function renderPhaseOverview(phases) {
            if (!phases.length) return '<div class="empty-state">No phase data available</div>';
            
            return `<div class="phases-grid">
                ${phases.map(phase => `
                    <div class="phase-item">
                        <h4>${phase.name}</h4>
                        <div class="phase-details">
                            <p><strong>Duration:</strong> ${phase.duration_days} days</p>
                            <p><strong>Temperature:</strong> ${phase.temperature_min}-${phase.temperature_max}°C</p>
                            <p><strong>Humidity:</strong> ${phase.humidity_min}-${phase.humidity_max}%</p>
                            <p><strong>CO2:</strong> ${phase.co2_min}-${phase.co2_max} ppm</p>
                            <p><strong>Light Hours:</strong> ${phase.light_hours_per_day}h/day</p>
                        </div>
                        <div class="phase-actions">
                            <button class="btn btn-sm btn-primary" onclick="editPhase('${phase.name}')">Edit Phase</button>
                            <button class="btn btn-sm btn-secondary" onclick="viewPhaseDetails('${phase.name}')">Details</button>
                        </div>
                    </div>
                `).join('')}
            </div>`;
        }

        function renderPhaseScheduling(environments) {
            return `
                <div class="phase-scheduling">
                    <div class="scheduling-form">
                        <h4>Schedule Phase Changes</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Chamber:</label>
                                <select id="phase-chamber-select" class="form-select">
                                    <option value="">Select Chamber</option>
                                    ${environments.map(env => `<option value="${env.id}">${env.name}</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label>New Phase:</label>
                                <select id="phase-new-phase" class="form-select">
                                    <option value="inoculation">Inoculation</option>
                                    <option value="colonization">Colonization</option>
                                    <option value="pinning">Pinning</option>
                                    <option value="fruiting">Fruiting</option>
                                    <option value="harvest">Harvest</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Schedule Date:</label>
                                <input type="datetime-local" id="phase-schedule-date" class="form-input">
                            </div>
                            <div class="form-group">
                                <label>Notes:</label>
                                <textarea id="phase-notes" class="form-input" placeholder="Optional notes"></textarea>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="executePhaseSchedule()">Schedule Phase Change</button>
                    </div>
                    
                    <div class="scheduled-changes">
                        <h4>Scheduled Phase Changes</h4>
                        <div id="scheduled-list">
                            <div class="empty-state">No scheduled phase changes</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderHarvestTracking(harvests) {
            return `
                <div class="harvest-tracking">
                    <div class="harvest-form">
                        <h4>Record New Harvest</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Chamber:</label>
                                <select id="harvest-chamber" class="form-select">
                                    <option value="">Select Chamber</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Weight (grams):</label>
                                <input type="number" id="harvest-weight" class="form-input" placeholder="0">
                            </div>
                            <div class="form-group">
                                <label>Quality Grade:</label>
                                <select id="harvest-grade" class="form-select">
                                    <option value="A">Grade A (Premium)</option>
                                    <option value="B">Grade B (Good)</option>
                                    <option value="C">Grade C (Standard)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Notes:</label>
                                <textarea id="harvest-notes" class="form-input" placeholder="Harvest notes"></textarea>
                            </div>
                        </div>
                        <button class="btn btn-success" onclick="submitHarvestRecord()">Record Harvest</button>
                    </div>
                    
                    <div class="harvest-history">
                        <h4>Harvest History</h4>
                        <div class="harvest-grid">
                            ${harvests.length ? harvests.map(harvest => `
                                <div class="harvest-item">
                                    <h5>Chamber ${harvest.chamber_id} - ${harvest.species_id}</h5>
                                    <p><strong>Weight:</strong> ${harvest.weight_grams}g | <strong>Grade:</strong> ${harvest.quality_grade}</p>
                                    <p><strong>Date:</strong> ${harvest.harvest_date}</p>
                                    <p><strong>Notes:</strong> ${harvest.notes || 'None'}</p>
                                </div>
                            `).join('') : '<div class="empty-state">No harvest records</div>'}
                        </div>
                    </div>
                </div>
            `;
        }

        // Action functions
        function schedulePhaseChange() {
            showPhaseTab('schedule');
        }

        function recordHarvest() {
            showPhaseTab('harvest');
        }

        function refreshPhaseData() {
            loadPhaseData().then(() => {
                showPhaseTab('overview');
                alert('Phase data refreshed successfully!');
            });
        }

        function executePhaseSchedule() {
            const chamber = document.getElementById('phase-chamber-select').value;
            const phase = document.getElementById('phase-new-phase').value;
            const date = document.getElementById('phase-schedule-date').value;
            
            if (!chamber || !phase || !date) {
                alert('Please fill in all required fields');
                return;
            }
            
            alert(`Phase change scheduled: Chamber ${chamber} to ${phase} phase on ${date}`);
        }

        function submitHarvestRecord() {
            const chamber = document.getElementById('harvest-chamber').value;
            const weight = document.getElementById('harvest-weight').value;
            const grade = document.getElementById('harvest-grade').value;
            
            if (!chamber || !weight) {
                alert('Please fill in chamber and weight');
                return;
            }
            
            alert(`Harvest recorded: ${weight}g from Chamber ${chamber}, Grade ${grade}`);
        }

        function editPhase(phaseName) {
            alert(`Editing phase: ${phaseName}`);
        }

        function viewPhaseDetails(phaseName) {
            alert(`Viewing details for phase: ${phaseName}`);
        }

        // Make functions globally accessible
        window.showPhaseTab = showPhaseTab;
        window.schedulePhaseChange = schedulePhaseChange;
        window.recordHarvest = recordHarvest;
        window.refreshPhaseData = refreshPhaseData;
    </script>
</body>
</html>
