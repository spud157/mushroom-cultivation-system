<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M.U.S.H - Sensor Data</title>
    <link rel="stylesheet" href="terminal-status.css">
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <header class="dashboard-header-section">
            <div class="header-content">
                <div class="dashboard-header">
                    <h1 class="main-title">M.U.S.H</h1>
                    <div class="header-controls-centered">
                        <button class="btn btn-primary" onclick="window.location.href='index.html'">
                            Dashboard
                        </button>
                        <button class="btn btn-success" onclick="window.location.href='automation-rules.html'">
                            Automation Rules
                        </button>
                        <button class="btn btn-info" onclick="window.location.href='alerts.html'">
                            Alerts & Notifications
                        </button>
                        <button class="btn btn-warning" onclick="window.location.href='phase-management.html'">
                            Phase Management
                        </button>
                        <button class="btn btn-secondary" onclick="window.location.href='batch-operations.html'">
                            Batch Operations
                        </button>
                        <button class="btn btn-danger active" onclick="window.location.href='sensor-data.html'">
                            Sensor Data
                        </button>
                        <button class="btn btn-dark" onclick="window.location.href='user-management.html'">
                            User Management
                        </button>
                        <button class="btn btn-light" onclick="logout()">
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- System Status -->
            <section class="system-status">
                <div class="status-card">
                    <h3>Real-Time Sensor Data</h3>
                    <div class="status-indicators">
                        <div class="status-item">
                            <span class="status-label">Connected Devices:</span>
                            <span class="status-value" id="connected-devices-count">0</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Data Points/Min:</span>
                            <span class="status-value" id="data-points-rate">0</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">System Health:</span>
                            <span class="status-value" id="sensor-system-health">Online</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Sensor Data Section -->
            <section class="sensor-data-section">
                <div class="section-header">
                    <h2>Sensor Monitoring</h2>
                    <div class="header-controls">
                        <button class="btn btn-primary" onclick="refreshSensorData()">Refresh Data</button>
                        <button class="btn btn-warning" onclick="calibrateSensors()">Calibrate Sensors</button>
                        <button class="btn btn-info" onclick="exportSensorData()">Export Data</button>
                    </div>
                </div>
                
                <!-- Tab Navigation -->
                <div class="sensor-tabs">
                    <button class="tab-btn active" onclick="showSensorTab('live')">Live Data</button>
                    <button class="tab-btn" onclick="showSensorTab('control')">Device Control</button>
                    <button class="tab-btn" onclick="showSensorTab('history')">Data History</button>
                </div>

                <!-- Content Area -->
                <div id="sensor-content" class="tab-content">
                    <div class="loading-message">Loading sensor data...</div>
                </div>
            </section>
        </main>
    </div>

    <!-- Trademark Footer -->
    <div class="trademark-footer">
        <span class="trademark-text">© Kroll Management LLC</span>
    </div>

    <script src="simple_app.js"></script>
    <script>
        let sensorData = {};
        let autoRefresh = true;
        let refreshInterval;

        // Page-specific initialization
        window.addEventListener('load', async function() {
            if (!checkAuthentication()) return;
            
            await loadSensorData();
            showSensorTab('live');
            startAutoRefresh();
        });

        async function loadSensorData() {
            try {
                const response = await fetch(`${API_BASE_URL}/sensors/data`);
                sensorData = await response.json();
            } catch (error) {
                console.error('Error loading sensor data:', error);
                document.getElementById('sensor-content').innerHTML = '<div class="error-message">Failed to load sensor data</div>';
            }
        }

        function showSensorTab(tab) {
            const content = document.getElementById('sensor-content');
            
            // Update tab buttons
            document.querySelectorAll('.sensor-tabs .tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            switch(tab) {
                case 'live':
                    content.innerHTML = renderLiveSensorData(sensorData);
                    break;
                case 'control':
                    content.innerHTML = renderDeviceControl();
                    break;
                case 'history':
                    content.innerHTML = renderSensorHistory();
                    break;
            }
        }

        function renderLiveSensorData(data) {
            if (!Object.keys(data).length) {
                return '<div class="empty-state">No sensor data available</div>';
            }

            return `
                <div class="sensor-controls">
                    <div class="auto-refresh-control">
                        <label class="checkbox-label">
                            <input type="checkbox" ${autoRefresh ? 'checked' : ''} onchange="toggleAutoRefresh()">
                            Auto-refresh (30s)
                        </label>
                        <span class="last-update">Last updated: ${new Date().toLocaleTimeString()}</span>
                    </div>
                </div>
                
                <div class="sensors-grid">
                    ${Object.entries(data).map(([deviceId, readings]) => `
                        <div class="sensor-device">
                            <div class="device-header">
                                <h4>${deviceId.replace('_', ' ').toUpperCase()}</h4>
                                <span class="device-status ${readings.status}">${readings.status}</span>
                            </div>
                            <div class="sensor-readings">
                                <div class="reading-item">
                                    <span class="reading-label">Temperature:</span>
                                    <span class="reading-value ${getReadingStatus(readings.temperature, 18, 25)}">${readings.temperature}°C</span>
                                </div>
                                <div class="reading-item">
                                    <span class="reading-label">Humidity:</span>
                                    <span class="reading-value ${getReadingStatus(readings.humidity, 80, 95)}">${readings.humidity}%</span>
                                </div>
                                <div class="reading-item">
                                    <span class="reading-label">CO2:</span>
                                    <span class="reading-value ${getReadingStatus(readings.co2, 400, 1000)}">${readings.co2} ppm</span>
                                </div>
                                <div class="reading-item">
                                    <span class="reading-label">Last Update:</span>
                                    <span class="reading-value">${readings.last_update}</span>
                                </div>
                            </div>
                            <div class="device-actions">
                                <button class="btn btn-sm btn-primary" onclick="viewDeviceDetails('${deviceId}')">Details</button>
                                <button class="btn btn-sm btn-warning" onclick="calibrateDevice('${deviceId}')">Calibrate</button>
                                <button class="btn btn-sm btn-secondary" onclick="resetDevice('${deviceId}')">Reset</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderDeviceControl() {
            return `
                <div class="device-control">
                    <div class="control-form">
                        <h4>Device Control Panel</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Device:</label>
                                <select id="control-device" class="form-select">
                                    <option value="esp32_chamber_01">ESP32 Chamber 01</option>
                                    <option value="esp32_chamber_02">ESP32 Chamber 02</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Action:</label>
                                <select id="control-action" class="form-select" onchange="updateControlForm()">
                                    <option value="">Select Action</option>
                                    <option value="set_temperature">Set Temperature Target</option>
                                    <option value="set_humidity">Set Humidity Target</option>
                                    <option value="toggle_fan">Toggle Fan</option>
                                    <option value="toggle_heater">Toggle Heater</option>
                                    <option value="toggle_humidifier">Toggle Humidifier</option>
                                    <option value="calibrate">Calibrate Sensors</option>
                                    <option value="restart">Restart Device</option>
                                </select>
                            </div>
                            <div class="form-group" id="control-value-group" style="display: none;">
                                <label id="control-value-label">Value:</label>
                                <input type="text" id="control-value" class="form-input" placeholder="Enter value">
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="sendDeviceCommand()">Send Command</button>
                    </div>
                    
                    <div class="command-history">
                        <h4>Recent Commands</h4>
                        <div id="command-history-list">
                            <div class="empty-state">No recent commands</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderSensorHistory() {
            return `
                <div class="sensor-history">
                    <div class="history-controls">
                        <h4>Sensor Data History</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Device:</label>
                                <select id="history-device" class="form-select">
                                    <option value="">All Devices</option>
                                    <option value="esp32_chamber_01">ESP32 Chamber 01</option>
                                    <option value="esp32_chamber_02">ESP32 Chamber 02</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Time Range:</label>
                                <select id="history-range" class="form-select">
                                    <option value="1h">Last Hour</option>
                                    <option value="24h">Last 24 Hours</option>
                                    <option value="7d">Last 7 Days</option>
                                    <option value="30d">Last 30 Days</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Data Type:</label>
                                <select id="history-type" class="form-select">
                                    <option value="all">All Sensors</option>
                                    <option value="temperature">Temperature Only</option>
                                    <option value="humidity">Humidity Only</option>
                                    <option value="co2">CO2 Only</option>
                                </select>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="loadHistoryData()">Load History</button>
                    </div>
                    
                    <div class="history-chart">
                        <div class="chart-placeholder">
                            <p>Select parameters and click "Load History" to view sensor data trends</p>
                            <div class="chart-mock">
                                <div class="chart-line"></div>
                                <div class="chart-points"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="history-table">
                        <h5>Data Points</h5>
                        <div id="history-table-content">
                            <div class="empty-state">No history data loaded</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function getReadingStatus(value, min, max) {
            if (value < min || value > max) return 'warning';
            return 'normal';
        }

        function updateControlForm() {
            const action = document.getElementById('control-action').value;
            const valueGroup = document.getElementById('control-value-group');
            const valueLabel = document.getElementById('control-value-label');
            const valueInput = document.getElementById('control-value');
            
            valueGroup.style.display = 'none';
            
            switch(action) {
                case 'set_temperature':
                    valueGroup.style.display = 'block';
                    valueLabel.textContent = 'Temperature (°C):';
                    valueInput.placeholder = 'e.g., 22';
                    break;
                case 'set_humidity':
                    valueGroup.style.display = 'block';
                    valueLabel.textContent = 'Humidity (%):';
                    valueInput.placeholder = 'e.g., 85';
                    break;
            }
        }

        function toggleAutoRefresh() {
            autoRefresh = !autoRefresh;
            if (autoRefresh) {
                startAutoRefresh();
            } else {
                stopAutoRefresh();
            }
        }

        function startAutoRefresh() {
            if (refreshInterval) clearInterval(refreshInterval);
            refreshInterval = setInterval(async () => {
                if (autoRefresh && document.querySelector('.sensor-tabs .tab-btn.active').textContent.includes('Live')) {
                    await loadSensorData();
                    showSensorTab('live');
                }
            }, 30000);
        }

        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }

        async function sendDeviceCommand() {
            const deviceId = document.getElementById('control-device').value;
            const action = document.getElementById('control-action').value;
            const value = document.getElementById('control-value').value;
            
            if (!action) {
                alert('Please select an action');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/sensors/control`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ device_id: deviceId, action, value })
                });
                
                const result = await response.json();
                alert(`Command sent successfully: ${result.status}`);
                
                // Add to command history
                addToCommandHistory({ deviceId, action, value, timestamp: new Date().toISOString() });
            } catch (error) {
                console.error('Device control error:', error);
                alert('Failed to send command');
            }
        }

        function addToCommandHistory(command) {
            const historyList = document.getElementById('command-history-list');
            if (!historyList) return;
            
            const historyItem = document.createElement('div');
            historyItem.className = 'history-item';
            historyItem.innerHTML = `
                <p><strong>${command.deviceId}:</strong> ${command.action} ${command.value || ''}</p>
                <p class="timestamp">${new Date(command.timestamp).toLocaleString()}</p>
            `;
            
            if (historyList.querySelector('.empty-state')) {
                historyList.innerHTML = '';
            }
            
            historyList.insertBefore(historyItem, historyList.firstChild);
        }

        function refreshSensorData() {
            loadSensorData().then(() => {
                if (document.querySelector('.sensor-tabs .tab-btn.active').textContent.includes('Live')) {
                    showSensorTab('live');
                }
                alert('Sensor data refreshed successfully!');
            });
        }

        function calibrateSensors() {
            alert('Sensor calibration initiated for all devices');
        }

        function exportSensorData() {
            alert('Sensor data export functionality - Coming Soon!');
        }

        function viewDeviceDetails(deviceId) {
            alert(`Viewing details for ${deviceId}`);
        }

        function calibrateDevice(deviceId) {
            alert(`Calibrating ${deviceId}`);
        }

        function resetDevice(deviceId) {
            if (confirm(`Reset ${deviceId}? This will restart the device.`)) {
                alert(`${deviceId} reset initiated`);
            }
        }

        function loadHistoryData() {
            const device = document.getElementById('history-device').value;
            const range = document.getElementById('history-range').value;
            const type = document.getElementById('history-type').value;
            
            alert(`Loading history: ${device || 'All devices'}, ${range}, ${type}`);
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            stopAutoRefresh();
        });

        // Make functions globally accessible
        window.showSensorTab = showSensorTab;
        window.refreshSensorData = refreshSensorData;
        window.calibrateSensors = calibrateSensors;
        window.exportSensorData = exportSensorData;
        window.sendDeviceCommand = sendDeviceCommand;
        window.updateControlForm = updateControlForm;
        window.toggleAutoRefresh = toggleAutoRefresh;
    </script>
</body>
</html>
