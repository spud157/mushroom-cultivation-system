<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M.U.S.H - Automation Rules Engine</title>
    <link rel="stylesheet" href="terminal-status.css">
    <link rel="stylesheet" href="automation-rules.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="app">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="dashboard-header">
                    <h1 class="main-title">M.U.S.H - Automation Rules Engine</h1>
                    <div class="header-controls-centered">
                        <button class="btn btn-primary" onclick="window.location.href='/'">Dashboard</button>
                        <button class="btn btn-success" onclick="refreshRules()">Refresh Rules</button>
                        <button class="btn btn-warning" onclick="testAllRules()">Test Rules</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- System Status -->
        <section class="status-section">
            <div class="status-card">
                <h3>Automation Engine Status</h3>
                <div class="status-grid">
                    <div class="status-item">
                        <span class="status-label">Engine Status:</span>
                        <span class="status-value status-active" id="engineStatus">ACTIVE</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Active Rules:</span>
                        <span class="status-value status-count" id="activeRules">8</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Rules Executed:</span>
                        <span class="status-value status-count" id="rulesExecuted">0</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Last Execution:</span>
                        <span class="status-value status-time" id="lastExecution">Never</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Rule Builder Section -->
        <section class="rules-section">
            <div class="section-header">
                <h2>Automation Rules</h2>
                <button class="btn btn-primary" onclick="showCreateRuleModal()">
                    Create New Rule
                </button>
            </div>
            
            <div class="rules-grid" id="rulesGrid">
                <!-- Rules will be dynamically generated here -->
            </div>
        </section>

        <!-- Rule Templates Section -->
        <section class="templates-section">
            <div class="section-header">
                <h2>Rule Templates</h2>
                <button class="btn btn-secondary" onclick="toggleTemplates()" id="templatesToggle">
                    [-] Collapse
                </button>
            </div>
            
            <div class="templates-grid" id="templatesGrid">
                <div class="template-card" onclick="createFromTemplate('humidity-control')">
                    <h4>Humidity Control</h4>
                    <p>Automatically maintain optimal humidity levels for assigned species</p>
                    <div class="template-tags">
                        <span class="tag">Beginner</span>
                        <span class="tag">Essential</span>
                    </div>
                </div>
                
                <div class="template-card" onclick="createFromTemplate('temperature-regulation')">
                    <h4>Temperature Regulation</h4>
                    <p>Maintain species-specific temperature ranges with heating/cooling</p>
                    <div class="template-tags">
                        <span class="tag">Beginner</span>
                        <span class="tag">Essential</span>
                    </div>
                </div>
                
                <div class="template-card" onclick="createFromTemplate('co2-management')">
                    <h4>CO2 Management</h4>
                    <p>Control CO2 levels during different growth phases</p>
                    <div class="template-tags">
                        <span class="tag">Intermediate</span>
                        <span class="tag">Growth</span>
                    </div>
                </div>
                
                <div class="template-card" onclick="createFromTemplate('fae-cycling')">
                    <h4>Fresh Air Exchange</h4>
                    <p>Automated FAE cycles based on species requirements</p>
                    <div class="template-tags">
                        <span class="tag">Intermediate</span>
                        <span class="tag">Airflow</span>
                    </div>
                </div>
                
                <div class="template-card" onclick="createFromTemplate('phase-progression')">
                    <h4>Phase Progression</h4>
                    <p>Automatically advance through growth phases based on conditions</p>
                    <div class="template-tags">
                        <span class="tag">Advanced</span>
                        <span class="tag">Automation</span>
                    </div>
                </div>
                
                <div class="template-card" onclick="createFromTemplate('emergency-shutdown')">
                    <h4>Emergency Shutdown</h4>
                    <p>Protect crops from extreme conditions with automatic shutdowns</p>
                    <div class="template-tags">
                        <span class="tag">Critical</span>
                        <span class="tag">Safety</span>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Create Rule Modal -->
    <div id="createRuleModal" class="modal">
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h2>Create Automation Rule</h2>
                <span class="close" onclick="closeCreateRuleModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="createRuleForm">
                    <!-- Rule Basic Info -->
                    <div class="form-section">
                        <h3>Rule Information</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="ruleName">Rule Name:</label>
                                <input type="text" id="ruleName" name="name" required placeholder="e.g., Lion's Mane Humidity Control">
                            </div>
                            <div class="form-group">
                                <label for="rulePriority">Priority:</label>
                                <select id="rulePriority" name="priority">
                                    <option value="low">Low</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="high">High</option>
                                    <option value="critical">Critical</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="ruleDescription">Description:</label>
                            <textarea id="ruleDescription" name="description" placeholder="Describe what this rule does"></textarea>
                        </div>
                    </div>

                    <!-- Rule Conditions -->
                    <div class="form-section">
                        <h3>Conditions (When to trigger)</h3>
                        <div class="conditions-builder" id="conditionsBuilder">
                            <div class="condition-group">
                                <div class="condition-row">
                                    <select class="condition-field">
                                        <option value="">Select Field</option>
                                        <option value="temperature">Temperature</option>
                                        <option value="humidity">Humidity</option>
                                        <option value="co2">CO2 Level</option>
                                        <option value="species">Species</option>
                                        <option value="phase">Growth Phase</option>
                                        <option value="time">Time of Day</option>
                                        <option value="chamber">Chamber</option>
                                    </select>
                                    <select class="condition-operator">
                                        <option value="equals">=</option>
                                        <option value="not_equals">≠</option>
                                        <option value="greater_than">></option>
                                        <option value="less_than"><</option>
                                        <option value="greater_equal">≥</option>
                                        <option value="less_equal">≤</option>
                                        <option value="contains">contains</option>
                                    </select>
                                    <input type="text" class="condition-value" placeholder="Value">
                                    <button type="button" class="btn btn-sm btn-danger" onclick="removeCondition(this)">Remove</button>
                                </div>
                            </div>
                            <div class="condition-controls">
                                <button type="button" class="btn btn-sm btn-secondary" onclick="addCondition()">Add Condition</button>
                                <select id="conditionLogic">
                                    <option value="and">AND (all conditions must be true)</option>
                                    <option value="or">OR (any condition can be true)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Rule Actions -->
                    <div class="form-section">
                        <h3>Actions (What to do)</h3>
                        <div class="actions-builder" id="actionsBuilder">
                            <div class="action-group">
                                <div class="action-row">
                                    <select class="action-type">
                                        <option value="">Select Action</option>
                                        <option value="set_temperature">Set Temperature</option>
                                        <option value="set_humidity">Set Humidity</option>
                                        <option value="set_co2">Set CO2 Level</option>
                                        <option value="turn_on_device">Turn On Device</option>
                                        <option value="turn_off_device">Turn Off Device</option>
                                        <option value="send_alert">Send Alert</option>
                                        <option value="change_phase">Change Growth Phase</option>
                                        <option value="wait">Wait/Delay</option>
                                    </select>
                                    <input type="text" class="action-value" placeholder="Value/Setting">
                                    <button type="button" class="btn btn-sm btn-danger" onclick="removeAction(this)">Remove</button>
                                </div>
                            </div>
                            <div class="action-controls">
                                <button type="button" class="btn btn-sm btn-secondary" onclick="addAction()">Add Action</button>
                            </div>
                        </div>
                    </div>

                    <!-- Rule Settings -->
                    <div class="form-section">
                        <h3>Rule Settings</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="ruleEnabled">
                                    <input type="checkbox" id="ruleEnabled" name="enabled" checked>
                                    Enable Rule
                                </label>
                            </div>
                            <div class="form-group">
                                <label for="ruleInterval">Check Interval (seconds):</label>
                                <input type="number" id="ruleInterval" name="interval" value="60" min="1" max="3600">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="ruleChambers">Apply to Chambers:</label>
                                <select id="ruleChambers" name="chambers" multiple>
                                    <option value="all">All Chambers</option>
                                    <!-- Chamber options will be populated dynamically -->
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeCreateRuleModal()">Cancel</button>
                <button type="button" class="btn btn-success" onclick="testRule()">Test Rule</button>
                <button type="button" class="btn btn-primary" onclick="createRule()">Create Rule</button>
            </div>
        </div>
    </div>

    <!-- Rule Details Modal -->
    <div id="ruleDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="ruleDetailsTitle">Rule Details</h2>
                <span class="close" onclick="closeRuleDetailsModal()">&times;</span>
            </div>
            <div class="modal-body" id="ruleDetailsBody">
                <!-- Rule details will be populated here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeRuleDetailsModal()">Close</button>
                <button type="button" class="btn btn-warning" onclick="editRule()">Edit Rule</button>
                <button type="button" class="btn btn-danger" onclick="deleteRule()">Delete Rule</button>
            </div>
        </div>
    </div>

    <!-- Trademark Footer -->
    <div class="trademark-footer">
        <span class="trademark-text">© Kroll Management LLC</span>
    </div>

    <script src="automation-rules.js"></script>
</body>
</html>
